# 一次高并发的经历

### 需求描述

1. 下单秒杀
2. 商品数量固定不能超发
3. 购买后商品需要分配
4. 每个商品独一无二单独编号



#### 第一次：

1. 下单接口逻辑

   >创建订单->订单放入消息队列->消息队列处理订单

2. 支付回调接口逻辑

   > 订单改成已支付->分配商品（没有做消息队列）

   **问题：**

   1. 下单接口消息队列超时过于频繁
   2. 支付回调的时候在高并发的情况下分配商品会分配到同一个后面的订单会覆盖前面的导致前面的订单支付了没有分配到商品

#### 第二次:
1. 下单接口逻辑

   >创建订单(订单状态待处理)->开一个控制台找到待处理订单->状态改成处理中（防止重复进入队列）->订单放入消息队列->消息队列处理订单

2. 支付回调接口逻辑

   > 订单加入分配状态->开一个控制台找到所有已支付并且待分配的订单->一个个分配
   
   

**问题：**

下单的问题得到了解决但是查询的时候因为很多按钮的显隐都是由后端控制在连接数过多的情况下数据库会卡死

#### 第三次

1. 拆分基础信息（实时性要求不高的）的信息和按钮显隐信息接口基础信息接口

2. 实时性要求不高做缓存处理缓存300s

3. 实时计算的数据部分改成加字段跟新的模式来减少查询次数

4. 频率高的字段加入索引

   **问题：**发现有人不停的直接调用接口购买商品

#### 第四次

1. 下单接口

   >加入web拦截来确定是否是真人在操作。接口方面加入各种限制条件

#### 问题跟新中......